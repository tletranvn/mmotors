
server {
    # Nginx ecoute sur le port 80 (HTTP standard)
    # Dans Docker, ce port sera mappe vers un port de l'hote (ex: 8080:80)
    listen 80;

    server_name localhost;

    # Symfony utilise un seul fichier d'entree : index.php
    # Tous les fichiers publics (CSS, JS, images) sont dans /public
    root /var/www/html/backend/public;

    # Quand on accede a un dossier (ex: /), Nginx cherche ces fichiers
    # dans l'ordre : index.php d'abord, puis index.html
    index index.php index.html;

    # C'est le pattern "Front Controller" : toutes les requetes non-statiques
    # passent par index.php qui decide quoi faire (routing Symfony)
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Traitement des fichiers PHP
    location ~ \.php$ {
        # try_files $uri =404 = Si le fichier PHP n'existe pas, erreur 404
        # Empeche les attaques qui tentent d'executer des fichiers inexistants
        try_files $uri =404;

        # FastCGI est le protocole de communication entre Nginx et PHP-FPM

        fastcgi_split_path_info ^(.+\.php)(/.+)$;

        # fastcgi_pass = Adresse du serveur PHP-FPM
        # "php" = Nom du service Docker (resolu par le reseau Docker)
        # 9000 = Port par defaut de PHP-FPM
        fastcgi_pass php:9000;

        # fastcgi_index = Fichier par defaut si on demande un dossier
        fastcgi_index index.php;

        # include fastcgi_params = Inclusion des parametres FastCGI standards
        include fastcgi_params;

        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        fastcgi_param PATH_INFO $fastcgi_path_info;

        # Temps maximum d'attente de la reponse PHP (en secondes)
        # 300s = 5 minutes, utile pour les longues operations
        # (imports, exports, traitements lourds)
        fastcgi_read_timeout 300;

        # Taille des buffers pour les reponses PHP
        # Evite les erreurs "upstream sent too big header"
        # quand Symfony renvoie beaucoup de headers ou de gros JSON
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
    }

    # Fichiers caches (images, CSS, JS, polices, etc.)
    # Ces fichiers sont servis directement par Nginx, sans passer par PHP
    location ~* \.(jpg|jpeg|gif|png|css|js|ico|svg|woff|woff2)$ {
        # expires 1y = Le navigateur garde ces fichiers en cache 1 an
        # Reduit les requetes serveur, accelere le site
        expires 1y;

        # add_header Cache-Control = Instruction de cache pour les proxies
        # "public" = Peut etre cache par tous (navigateurs, CDN, proxies)
        add_header Cache-Control "public, immutable";

        # access_log off = Ne pas logger ces requetes
        # Reduit la taille des logs, ces requetes sont peu interessantes
        access_log off;
    }

    # Securite : interdire l'acces aux fichiers caches
    location ~ /\. {
        deny all;
    }

    # Logs Nginx
    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
}
