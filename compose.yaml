
services:
 
  database:
    # Image officielle PostgreSQL version 17 sur Alpine Linux
    image: postgres:17-alpine

    # Nom explicite du container (facilite les logs et commandes)
    container_name: mmotors_postgres

    environment:
      POSTGRES_DB: ${POSTGRES_DB}            
      POSTGRES_USER: ${POSTGRES_USER}        
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} 

    ports:
      - "5432:5432"

    # Verifie periodiquement que PostgreSQL est operationnel
    # Les autres services peuvent attendre que database soit "healthy"
    healthcheck:
      # pg_isready = Commande PostgreSQL qui teste si le serveur accepte les connexions
      test: ["CMD", "pg_isready", "-d", "${POSTGRES_DB}", "-U", "${POSTGRES_USER}"]
      timeout: 5s        # Temps max pour chaque test
      retries: 5         # Nombre d'essais avant echec
      start_period: 60s  # Temps de grace au demarrage

    volumes:
      # Volume nomme : Docker gere automatiquement l'emplacement sur le disque
      - database_data:/var/lib/postgresql/data:rw

    networks:
      - mmotors_network

  php:
    # Au lieu d'utiliser une image pre-construite, on construit notre propre
    # image a partir du Dockerfile
    build:
      context: .                    # Contexte = dossier racine du projet
      dockerfile: docker/php/Dockerfile  # Chemin vers notre Dockerfile

    container_name: mmotors_php

    volumes:
      # Monte tout le projet dans /var/www/html
      # Le code est ainsi accessible dans le container
      - .:/var/www/html

    # Repertoire de travail pour les commandes PHP
    working_dir: /var/www/html/backend

    environment:
      # Environnement de l'application (dev, prod, test)
      APP_ENV: dev

      # URL de connexion a la base de donnees PostgreSQL
      DATABASE_URL: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database:5432/${POSTGRES_DB}?serverVersion=17&charset=utf8"

    
    # depends_on = Ce service demarre APRES les services listes
    depends_on:
      database:
        condition: service_healthy

    networks:
      - mmotors_network

  nginx:
    # Image officielle Nginx sur Alpine
    image: nginx:alpine

    container_name: mmotors_nginx

    # 8080:80 = Accedez a l'API via http://localhost:8080
    # On utilise 8080 plutot que 80 car 80 necessite souvent des droits admin
    ports:
      - "8080:80"

    volumes:
      # Monte le code source (pour servir les fichiers statiques)
      - .:/var/www/html

      # Monte notre configuration Nginx personnalisee
      # :ro = read-only (Nginx n'a pas besoin de modifier ce fichier)
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

    # Nginx doit demarrer APRES PHP car il lui transmet les requetes
    depends_on:
      - php

    networks:
      - mmotors_network

  # Node.js execute le serveur de developpement Vite pour React.
  # En developpement : Hot Reload (rechargement automatique)
  # En production : On buildrait les assets et les servirait via Nginx
  # ===========================================================================
  node:
    # Construction depuis notre Dockerfile
    build:
      context: .
      dockerfile: docker/node/Dockerfile

    container_name: mmotors_node

    ports:
      - "5173:5173"

    volumes:
      # Monte tout le projet
      - .:/var/www/html

      # IMPORTANT : Volume anonyme pour node_modules
      # Cela empeche les node_modules de l'hote d'ecraser ceux du container
      # Les dependances npm seront installees DANS le container
      - /var/www/html/frontend/node_modules

    # Dossier de travail pour les commandes npm
    working_dir: /var/www/html/frontend

    environment:
      # Environnement Node.js
      NODE_ENV: development

      # IMPORTANT : Permet a Vite d'etre accessible depuis l'exterieur du container
      # Sans cela, Vite n'ecoute que sur localhost (inaccessible depuis l'hote)
      VITE_HOST: "0.0.0.0"

    # Garde le container interactif (necessaire pour certaines commandes npm)
    stdin_open: true
    tty: true

    networks:
      - mmotors_network

# Utilisez "docker volume ls" pour les voir
# Utilisez "docker volume rm mmotors_database_data" pour supprimer
volumes:
  database_data:
    # Driver par defaut (local) : stocke sur le disque de l'hote

# Par leurs noms de service (database, php, nginx, node)
networks:
  mmotors_network:
    # Driver bridge : Reseau prive isole
    # Les containers peuvent se parler, mais sont isoles du reseau hote
    driver: bridge
